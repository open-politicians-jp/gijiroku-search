# name: ðŸŒ Deploy to GitHub Pages

# on:
#   # Deploy when a new release is created
#   release:
#     types: [published]
  
#   # Manual deployment trigger
#   workflow_dispatch:
#     inputs:
#       deploy_environment:
#         description: 'Deployment environment'
#         required: true
#         default: 'production'
#         type: choice
#         options:
#         - production
#         - staging

# # Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
# permissions:
#   contents: read
#   pages: write
#   id-token: write

# # Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# concurrency:
#   group: "pages"
#   cancel-in-progress: false

# jobs:
#   # Build job
#   build:
#     runs-on: ubuntu-latest
#     steps:
#     - name: ðŸ“¥ Checkout
#       uses: actions/checkout@v4
      
#     - name: ðŸŸ¢ Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'
#         cache: 'npm'
#         cache-dependency-path: frontend/package-lock.json
        
#     - name: ðŸ“¦ Install dependencies
#       working-directory: frontend
#       run: npm ci
      
#     - name: ðŸ—ï¸ Setup Pages
#       uses: actions/configure-pages@v4
#       with:
#         static_site_generator: next
        
#     - name: ðŸ“Š Prepare data for GitHub Pages
#       working-directory: frontend
#       env:
#         GITHUB_PAGES: 'true'
#       run: |
#         echo "Preparing data files for GitHub Pages deployment..."
#         echo "Data files are ready for production build."
        
#     - name: ðŸ”§ Build with Next.js
#       working-directory: frontend
#       env:
#         NODE_ENV: production
#         GITHUB_PAGES: 'true'
#         NEXT_PUBLIC_BASE_PATH: '/gijiroku-search'
#         NEXT_PUBLIC_VERSION: ${{ github.event.release.tag_name || 'development' }}
#         NEXT_PUBLIC_BUILD_TIME: ${{ github.run_id }}
#         GITHUB_SHA: ${{ github.sha }}
#       run: |
#         echo "Building for GitHub Pages..."
#         echo "Version: $NEXT_PUBLIC_VERSION"
#         npm run build
        
#     - name: ðŸ“¤ Upload artifact
#       uses: actions/upload-pages-artifact@v3
#       with:
#         path: ./frontend/out

#   # Deployment job
#   deploy:
#     environment:
#       name: github-pages
#       url: ${{ steps.deployment.outputs.page_url }}
#     runs-on: ubuntu-latest
#     needs: build
#     steps:
#     - name: ðŸš€ Deploy to GitHub Pages
#       id: deployment
#       uses: actions/deploy-pages@v4
      
#     - name: ðŸ“Š Deployment Summary
#       run: |
#         echo "## ðŸŒ GitHub Pages Deployment Complete!" >> $GITHUB_STEP_SUMMARY
#         echo "" >> $GITHUB_STEP_SUMMARY
#         echo "- **Environment**: ${{ github.event.inputs.deploy_environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
#         echo "- **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
#         echo "- **Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
#         echo "- **Build Time**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
name: ðŸŒ Deploy static Next.js to GitHub Pages
on:
  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆæ™‚ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  release:
    types: [published]

  # æ‰‹å‹•ãƒˆãƒªã‚¬
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: Deployment environment
        default: production
        type: choice
        options: [production, staging]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. ã‚½ãƒ¼ã‚¹å–å¾—
      - uses: actions/checkout@v4

      # 2. Node ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # 3. ä¾å­˜è§£æ±º
      - name: ðŸ“¦ Install dependencies
        working-directory: frontend
        run: npm ci

      # 4. Next.js é™çš„ãƒ“ãƒ«ãƒ‰ï¼ˆoutput: exportï¼‰
      - name: ðŸ”§ Build for GitHub Pages
        working-directory: frontend
        env:
          NODE_ENV: production
          GITHUB_PAGES: 'true'          # â† basePath / assetPrefix ã‚’æœ‰åŠ¹åŒ–
          NEXT_PUBLIC_BASE_PATH: '/gijiroku-search'
          NEXT_PUBLIC_VERSION: ${{ github.event.release.tag_name || 'dev' }}
          NEXT_PUBLIC_BUILD_TIME: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          echo "Building static site..."
          npm run build                 # next build ã®ã¿

      # 5. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/out            # out/ ãƒ•ã‚©ãƒ«ãƒ€ä¸¸ã”ã¨

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        name: ðŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸŒ GitHub Pages Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.deploy_environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
