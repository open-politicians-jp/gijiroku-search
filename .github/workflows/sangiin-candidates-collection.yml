name: ðŸ›ï¸ å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†

on:
  workflow_dispatch:
    inputs:
      data_format:
        description: 'å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿å½¢å¼'
        required: false
        default: 'both'
        type: choice
        options:
        - both
        - json
        - csv
      target_parties:
        description: 'å¯¾è±¡æ”¿å…šï¼ˆall, ldp, cdp, etc.ï¼‰'
        required: false
        default: 'all'
        type: string
      update_mode:
        description: 'æ›´æ–°ãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'incremental'
        type: choice
        options:
        - incremental
        - full
        - test
      max_candidates:
        description: 'æœ€å¤§å€™è£œè€…æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰'
        required: false
        default: '1000'
        type: string

# GitHub Actionsã§ã®commit/pushæ¨©é™è¨­å®š
permissions:
  contents: write
  actions: read

jobs:
  collect-sangiin-candidates:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: ðŸ”§ Setup uv environment
      working-directory: scripts/uv-data-collection
      run: |
        uv sync
        
    - name: ðŸ“Š å®Ÿè¡Œå‰çŠ¶æ³ç¢ºèª
      working-directory: scripts/uv-data-collection
      run: |
        echo "## ðŸ›ï¸ å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†é–‹å§‹" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: ${{ github.event.inputs.data_format || 'both' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¯¾è±¡æ”¿å…š**: ${{ github.event.inputs.target_parties || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°ãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.update_mode || 'incremental' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€å¤§å€™è£œè€…æ•°**: ${{ github.event.inputs.max_candidates || '1000' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        if [ -f "../../frontend/public/data/sangiin_candidates/candidates_latest.json" ]; then
          candidates_count=$(jq '.data | length' ../../frontend/public/data/sangiin_candidates/candidates_latest.json 2>/dev/null || echo "0")
          echo "ðŸ“Š **æ—¢å­˜å€™è£œè€…ãƒ‡ãƒ¼ã‚¿**: ${candidates_count}å" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“Š **æ—¢å­˜å€™è£œè€…ãƒ‡ãƒ¼ã‚¿**: ãªã—ï¼ˆåˆå›žå®Ÿè¡Œï¼‰" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ›ï¸ å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†
      working-directory: scripts/uv-data-collection
      env:
        DATA_FORMAT: ${{ github.event.inputs.data_format || 'both' }}
        TARGET_PARTIES: ${{ github.event.inputs.target_parties || 'all' }}
        UPDATE_MODE: ${{ github.event.inputs.update_mode || 'incremental' }}
        MAX_CANDIDATES: ${{ github.event.inputs.max_candidates || '1000' }}
      run: |
        echo "ðŸ›ï¸ å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†ã‚’é–‹å§‹ã—ã¾ã™..."
        
        # ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’æ§‹ç¯‰
        args=""
        
        if [ "$DATA_FORMAT" = "json" ]; then
          args="$args --json-only"
        elif [ "$DATA_FORMAT" = "csv" ]; then
          args="$args --csv-only"
        fi
        
        if [ "$TARGET_PARTIES" != "all" ]; then
          args="$args --parties $TARGET_PARTIES"
        fi
        
        if [ "$UPDATE_MODE" = "full" ]; then
          args="$args --force-update"
        elif [ "$UPDATE_MODE" = "test" ]; then
          args="$args --test-mode"
        fi
        
        if [ "$MAX_CANDIDATES" != "1000" ]; then
          args="$args --max-candidates $MAX_CANDIDATES"
        fi
        
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        echo "å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰: uv run python collect_sangiin_2025_candidates.py $args"
        uv run python collect_sangiin_2025_candidates.py $args
        
    - name: ðŸ“Š åŽé›†çµæžœã®ç¢ºèªã¨é›†è¨ˆ
      working-directory: scripts/uv-data-collection
      run: |
        echo "## ðŸ“Š åŽé›†çµæžœ" >> $GITHUB_STEP_SUMMARY
        
        # JSONå½¢å¼ã®çµæžœç¢ºèª
        if [ -f "../../frontend/public/data/sangiin_candidates/candidates_latest.json" ]; then
          candidates_count=$(jq '.data | length' ../../frontend/public/data/sangiin_candidates/candidates_latest.json 2>/dev/null || echo "0")
          echo "- **JSONå€™è£œè€…æ•°**: ${candidates_count}å" >> $GITHUB_STEP_SUMMARY
          
          # æ”¿å…šåˆ¥é›†è¨ˆ
          echo "### æ”¿å…šåˆ¥å€™è£œè€…æ•°" >> $GITHUB_STEP_SUMMARY
          jq -r '.data | group_by(.party) | .[] | "\(.length)å: \(.[0].party)"' ../../frontend/public/data/sangiin_candidates/candidates_latest.json 2>/dev/null | sort -nr >> $GITHUB_STEP_SUMMARY || echo "- é›†è¨ˆã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **JSONçµæžœ**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi
        
        # CSVå½¢å¼ã®çµæžœç¢ºèª
        if [ -f "../../frontend/public/data/sangiin_candidates/candidates_latest.csv" ]; then
          csv_count=$(tail -n +2 ../../frontend/public/data/sangiin_candidates/candidates_latest.csv | wc -l | tr -d ' ')
          echo "- **CSVå€™è£œè€…æ•°**: ${csv_count}å" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **CSVçµæžœ**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
        echo "### ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
        if [ -f "../../frontend/public/data/sangiin_candidates/candidates_latest.json" ]; then
          # ç©ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
          empty_names=$(jq '[.data[] | select(.name == "" or .name == null)] | length' ../../frontend/public/data/sangiin_candidates/candidates_latest.json 2>/dev/null || echo "0")
          empty_parties=$(jq '[.data[] | select(.party == "" or .party == null)] | length' ../../frontend/public/data/sangiin_candidates/candidates_latest.json 2>/dev/null || echo "0")
          
          echo "- **ç©ºã®å€™è£œè€…å**: ${empty_names}ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **ç©ºã®æ”¿å…šå**: ${empty_parties}ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action [Sangiin Candidates Collection]"
        
        # å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
        git add frontend/public/data/sangiin_candidates/ || true
        
        if ! git diff --staged --quiet; then
          timestamp=$(date '+%Y-%m-%d %H:%M:%S JST')
          candidates_count="0"
          
          # å€™è£œè€…æ•°ã‚’å–å¾—ã—ã¦ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹
          if [ -f "frontend/public/data/sangiin_candidates/candidates_latest.json" ]; then
            candidates_count=$(jq '.data | length' frontend/public/data/sangiin_candidates/candidates_latest.json 2>/dev/null || echo "0")
          fi
          
          commit_message="ðŸ›ï¸ å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†: ${candidates_count}å - ${timestamp}"
          git commit -m "$commit_message"
          git push
          
          echo "âœ… **ã‚³ãƒŸãƒƒãƒˆå®Œäº†**: $commit_message" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **å¤‰æ›´ãªã—**: æ–°è¦ãƒ‡ãƒ¼ã‚¿ãªã—" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“‹ å®Ÿè¡Œã‚µãƒžãƒªãƒ¼
      if: always()
      run: |
        echo "## ðŸ“‹ å®Ÿè¡Œå®Œäº†ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Œäº†æ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ¬¡å›žå®Ÿè¡Œæ™‚ã®æŽ¨å¥¨è¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- **å®šæœŸå®Ÿè¡Œ**: é€±1å›žï¼ˆé‡‘æ›œæ—¥ï¼‰æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°ãƒ¢ãƒ¼ãƒ‰**: incrementalï¼ˆå·®åˆ†æ›´æ–°ï¼‰æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: bothï¼ˆJSON + CSVï¼‰æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **PR #84**: å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Issue #83**: å‚é™¢é¸2025å€™è£œè€…ãƒ‡ãƒ¼ã‚¿åŽé›†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…" >> $GITHUB_STEP_SUMMARY