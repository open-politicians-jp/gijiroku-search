name: ðŸ“ è­°äº‹éŒ²è¦ç´„ç”Ÿæˆãƒãƒƒãƒ

on:
  schedule:
    # æ¯Žé€±åœŸæ›œæ—¥ã®åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œï¼ˆUTC 17:00 é‡‘æ›œæ—¥ï¼‰
    - cron: '0 17 * * 5'
  workflow_dispatch:
    inputs:
      target_period:
        description: 'è¦ç´„å¯¾è±¡æœŸé–“ï¼ˆall, recent_week, recent_monthï¼‰'
        required: false
        default: 'recent_week'
        type: choice
        options:
        - recent_week
        - recent_month
        - all
      force_regenerate:
        description: 'æ—¢å­˜è¦ç´„ã®å†ç”Ÿæˆ'
        required: false
        default: false
        type: boolean
      max_speeches:
        description: 'æœ€å¤§å‡¦ç†ä»¶æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰'
        required: false
        default: '100'
        type: string

# GitHub Actionsã§ã®commit/pushæ¨©é™è¨­å®š
permissions:
  contents: write
  actions: read

jobs:
  generate-speech-summaries:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: ðŸ”§ Setup uv environment
      working-directory: scripts/uv-data-collection
      run: |
        uv sync
        
    - name: ðŸ“Š å®Ÿè¡Œå‰çŠ¶æ³ç¢ºèª
      working-directory: scripts/uv-data-collection
      run: |
        echo "## ðŸ“ è­°äº‹éŒ²è¦ç´„ç”Ÿæˆãƒãƒƒãƒé–‹å§‹" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **å¯¾è±¡æœŸé–“**: ${{ github.event.inputs.target_period || 'recent_week' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¼·åˆ¶å†ç”Ÿæˆ**: ${{ github.event.inputs.force_regenerate || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€å¤§å‡¦ç†ä»¶æ•°**: ${{ github.event.inputs.max_speeches || '100' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ—¢å­˜è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        speeches_count=$(find ../../frontend/public/data/speeches -name "*.json" | wc -l | tr -d ' ')
        echo "ðŸ“Š **æ—¢å­˜è­°äº‹éŒ²ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${speeches_count}ä»¶" >> $GITHUB_STEP_SUMMARY
        
        # æ—¢å­˜è¦ç´„ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        if [ -d "../../frontend/public/data/summaries" ]; then
          summaries_count=$(find ../../frontend/public/data/summaries -name "*.json" | wc -l | tr -d ' ')
          echo "ðŸ“Š **æ—¢å­˜è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${summaries_count}ä»¶" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“Š **æ—¢å­˜è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 0ä»¶ï¼ˆåˆå›žå®Ÿè¡Œï¼‰" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“ è­°äº‹éŒ²è¦ç´„ç”Ÿæˆ
      working-directory: scripts/uv-data-collection
      env:
        TARGET_PERIOD: ${{ github.event.inputs.target_period || 'recent_week' }}
        FORCE_REGENERATE: ${{ github.event.inputs.force_regenerate || 'false' }}
        MAX_SPEECHES: ${{ github.event.inputs.max_speeches || '100' }}
        # OpenAI API Key (GitHub Secretsã‹ã‚‰è¨­å®šã™ã‚‹å ´åˆ)
        # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "ðŸ“ è­°äº‹éŒ²è¦ç´„ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™..."
        
        # ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’æ§‹ç¯‰
        args="--period $TARGET_PERIOD"
        
        if [ "$FORCE_REGENERATE" = "true" ]; then
          args="$args --force-regenerate"
        fi
        
        if [ "$MAX_SPEECHES" != "100" ]; then
          args="$args --max-speeches $MAX_SPEECHES"
        fi
        
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        echo "å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰: uv run python generate_speech_summaries.py $args"
        uv run python generate_speech_summaries.py $args
        
    - name: ðŸ“Š è¦ç´„ç”Ÿæˆçµæžœã®ç¢ºèª
      working-directory: scripts/uv-data-collection
      run: |
        echo "## ðŸ“Š è¦ç´„ç”Ÿæˆçµæžœ" >> $GITHUB_STEP_SUMMARY
        
        # ç”Ÿæˆã•ã‚ŒãŸè¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        if [ -d "../../frontend/public/data/summaries" ]; then
          summaries_count=$(find ../../frontend/public/data/summaries -name "*.json" | wc -l | tr -d ' ')
          echo "- **ç”Ÿæˆè¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${summaries_count}ä»¶" >> $GITHUB_STEP_SUMMARY
          
          # æœ€æ–°è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°
          latest_summary=$(find ../../frontend/public/data/summaries -name "*.json" -type f -exec ls -t {} + | head -1)
          if [ -n "$latest_summary" ]; then
            summary_items=$(jq 'length' "$latest_summary" 2>/dev/null || echo "0")
            echo "- **æœ€æ–°è¦ç´„ä»¶æ•°**: ${summary_items}ä»¶" >> $GITHUB_STEP_SUMMARY
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
            file_size=$(ls -lh "$latest_summary" | awk '{print $5}')
            echo "- **æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${file_size}" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **è¦ç´„çµæžœ**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
        if [ -f "summary_generation.log" ]; then
          error_count=$(grep -c "ERROR" summary_generation.log || echo "0")
          warning_count=$(grep -c "WARNING" summary_generation.log || echo "0")
          echo "- **ã‚¨ãƒ©ãƒ¼ä»¶æ•°**: ${error_count}ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **è­¦å‘Šä»¶æ•°**: ${warning_count}ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ”§ å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²
      working-directory: scripts/uv-data-collection
      run: |
        # å¤§ããªè¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²
        uv run python split_large_summaries.py || true
        
    - name: ðŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action [Speech Summary Generation]"
        
        # è¦ç´„ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
        git add frontend/public/data/summaries/ || true
        
        if ! git diff --staged --quiet; then
          timestamp=$(date '+%Y-%m-%d %H:%M:%S JST')
          
          # ç”Ÿæˆã•ã‚ŒãŸè¦ç´„æ•°ã‚’å–å¾—
          summaries_count="0"
          if [ -d "frontend/public/data/summaries" ]; then
            summaries_count=$(find frontend/public/data/summaries -name "*.json" | wc -l | tr -d ' ')
          fi
          
          commit_message="ðŸ“ è­°äº‹éŒ²è¦ç´„ç”Ÿæˆ: ${summaries_count}ãƒ•ã‚¡ã‚¤ãƒ« - ${timestamp}"
          git commit -m "$commit_message"
          git push
          
          echo "âœ… **ã‚³ãƒŸãƒƒãƒˆå®Œäº†**: $commit_message" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **å¤‰æ›´ãªã—**: æ–°è¦è¦ç´„ãªã—" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“‹ å®Ÿè¡Œã‚µãƒžãƒªãƒ¼
      if: always()
      run: |
        echo "## ðŸ“‹ å®Ÿè¡Œå®Œäº†ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Œäº†æ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ¬¡å›žå®Ÿè¡Œæ™‚ã®æŽ¨å¥¨è¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- **å®šæœŸå®Ÿè¡Œ**: é€±1å›žï¼ˆåœŸæ›œæ—¥æ—©æœï¼‰æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        echo "- **å¯¾è±¡æœŸé–“**: recent_weekï¼ˆéŽåŽ»1é€±é–“ï¼‰æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        echo "- **å¼·åˆ¶å†ç”Ÿæˆ**: falseï¼ˆé€šå¸¸ï¼‰æŽ¨å¥¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **åˆ©ç”¨ç›®çš„**: è­°äº‹éŒ²ã®è¦ç´„ã«ã‚ˆã‚Šæ”¿ç­–å‹•å‘ã®æŠŠæ¡ã‚’æ”¯æ´" >> $GITHUB_STEP_SUMMARY